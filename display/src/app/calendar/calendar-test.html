<!DOCTYPE html>

<html>

<head>

    <title>Google Calendar Events</title>

    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script src="https://apis.google.com/js/api.js"></script>

    <script>

        let tokenClient;

        let gapiInited = false;

        let gisInited = false;



        function gapiLoaded() {

            gapi.load('client', initializeGapiClient);

        }



        async function initializeGapiClient() {

            await gapi.client.init({

                apiKey: 'AIzaSyDKUfxX-7Z_uv6qBc6LTNZy8mQNMMJ2JQs',

                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],

            });

            gapiInited = true;

            maybeEnableButtons();

        }



        function gisLoaded() {

            tokenClient = google.accounts.oauth2.initTokenClient({

                client_id: '621701457931-ufnkse0r4vhhr2h6csbemdmcj8hrbii6.apps.googleusercontent.com',

                scope: 'https://www.googleapis.com/auth/calendar.readonly',

                callback: '', // defined later

            });

            gisInited = true;

            maybeEnableButtons();

        }



        function maybeEnableButtons() {

            if (gapiInited && gisInited) {

                document.getElementById('authorize_button').style.visibility = 'visible';

            }

        }



        function handleAuthClick() {

            tokenClient.callback = async (resp) => {

                if (resp.error !== undefined) {

                    throw (resp);

                }

                await listUpcomingEvents();

            };



            if (gapi.client.getToken() === null) {

                tokenClient.requestAccessToken({prompt: 'consent'});

            } else {

                tokenClient.requestAccessToken({prompt: ''});

            }

        }



        async function listUpcomingEvents() {

            let response;

            try {

                response = await gapi.client.calendar.events.list({

                    'calendarId': 'primary',

                    'timeMin': (new Date()).toISOString(),

                    'showDeleted': false,

                    'singleEvents': true,

                    'maxResults': 10,

                    'orderBy': 'startTime'

                });

            } catch (err) {

                console.error(err.message);

                return;

            }



            const events = response.result.items;

            const output = document.getElementById('events');

            if (!events || events.length == 0) {

                output.innerHTML = '<p>No upcoming events found.</p>';

                return;

            }



            output.innerHTML = '<h2>Upcoming events:</h2>';

            for (let i = 0; i < events.length; i++) {

                const event = events[i];

                const when = event.start.dateTime || event.start.date;

                output.innerHTML += `<p>${event.summary} (${when})</p>`;

            }

        }

    </script>

</head>

<body>

    <h1>Upcoming Google Calendar Events</h1>

    <button id="authorize_button" style="visibility: hidden;" onclick="handleAuthClick()">Authorize</button>

    <div id="events"></div>

    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>

    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

</body>

</html>